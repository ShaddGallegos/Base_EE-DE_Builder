- name: Ensure ~/.ansible/conf/env.yml contains required credentials
  hosts: localhost
  gather_facts: false
  vars:
    env_conf_home: >-
      {{
        ('/home/' ~ lookup('env', 'SUDO_USER'))
        if (lookup('env', 'SUDO_USER') | default('', true) | length > 0)
        else lookup('env', 'HOME')
      }}
    env_conf_dir: "{{ env_conf_home }}/.ansible/conf"
    env_conf_path: "{{ env_conf_dir }}/env.yml"
  tasks:
    - name: Ensure ~/.ansible/conf directory exists
      ansible.builtin.file:
        path: "{{ env_conf_dir }}"
        state: directory
        mode: '0700'

    - name: Ensure env.yml file exists
      ansible.builtin.file:
        path: "{{ env_conf_path }}"
        state: touch
        mode: '0600'

    - name: Read env.yml
      ansible.builtin.slurp:
        src: "{{ env_conf_path }}"
      register: env_conf_slurp

    - name: Parse env.yml lines
      ansible.builtin.set_fact:
        env_conf_lines: "{{ (env_conf_slurp.content | b64decode).splitlines() }}"

    - name: Extract RH_CREDENTIALS_TOKEN value
      ansible.builtin.set_fact:
        rh_credentials_token: >-
          {{ env_conf_lines | select('match', '^\s*(export\s+)?RH_CREDENTIALS_TOKEN\s*=')
             | map('regex_replace', '^\s*(export\s+)?RH_CREDENTIALS_TOKEN\s*=\s*', '')
             | list | first | default('') | trim }}

    - name: Extract REDHAT_CDN_USERNAME value
      ansible.builtin.set_fact:
        redhat_cdn_username: >-
          {{ env_conf_lines | select('match', '^\s*(export\s+)?REDHAT_CDN_USERNAME\s*=')
             | map('regex_replace', '^\s*(export\s+)?REDHAT_CDN_USERNAME\s*=\s*', '')
             | list | first | default('') | trim }}

    - name: Extract REDHAT_CDN_PASSWORD value
      ansible.builtin.set_fact:
        redhat_cdn_password: >-
          {{ env_conf_lines | select('match', '^\s*(export\s+)?REDHAT_CDN_PASSWORD\s*=')
             | map('regex_replace', '^\s*(export\s+)?REDHAT_CDN_PASSWORD\s*=\s*', '')
             | list | first | default('') | trim }}

    - name: Prompt for missing RH_CREDENTIALS_TOKEN
      ansible.builtin.pause:
        prompt: "Enter your Red Hat Automation Hub token"
        echo: false
      register: prompt_rh_token
      when: rh_credentials_token | trim | length == 0

    - name: Add missing RH_CREDENTIALS_TOKEN to env.yml
      ansible.builtin.lineinfile:
        path: "{{ env_conf_path }}"
        line: "RH_CREDENTIALS_TOKEN={{ prompt_rh_token.user_input }}"
        create: true
        mode: '0600'
        insertafter: EOF
      when: rh_credentials_token | trim | length == 0

    - name: Prompt for missing REDHAT_CDN_USERNAME
      ansible.builtin.pause:
        prompt: "Enter your Red Hat CDN username"
      register: prompt_rh_user
      when: redhat_cdn_username | trim | length == 0

    - name: Add missing REDHAT_CDN_USERNAME to env.yml
      ansible.builtin.lineinfile:
        path: "{{ env_conf_path }}"
        line: "REDHAT_CDN_USERNAME={{ prompt_rh_user.user_input }}"
        create: true
        mode: '0600'
        insertafter: EOF
      when: redhat_cdn_username | trim | length == 0

    - name: Prompt for missing REDHAT_CDN_PASSWORD
      ansible.builtin.pause:
        prompt: "Enter your Red Hat CDN password"
        echo: false
      register: prompt_rh_pass
      when: redhat_cdn_password | trim | length == 0

    - name: Add missing REDHAT_CDN_PASSWORD to env.yml
      ansible.builtin.lineinfile:
        path: "{{ env_conf_path }}"
        line: "REDHAT_CDN_PASSWORD={{ prompt_rh_pass.user_input }}"
        create: true
        mode: '0600'
        insertafter: EOF
      when: redhat_cdn_password | trim | length == 0
